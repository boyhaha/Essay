<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>进阶操作 | 娃哈哈</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/Essay/assets/css/0.styles.c2c42747.css" as="style"><link rel="preload" href="/Essay/assets/js/app.4cbbe458.js" as="script"><link rel="preload" href="/Essay/assets/js/2.495d5abd.js" as="script"><link rel="preload" href="/Essay/assets/js/26.041d7297.js" as="script"><link rel="prefetch" href="/Essay/assets/js/10.b9978adb.js"><link rel="prefetch" href="/Essay/assets/js/100.dd55bd5e.js"><link rel="prefetch" href="/Essay/assets/js/101.186c560e.js"><link rel="prefetch" href="/Essay/assets/js/102.c44c2ced.js"><link rel="prefetch" href="/Essay/assets/js/103.4c5a8827.js"><link rel="prefetch" href="/Essay/assets/js/104.175affa8.js"><link rel="prefetch" href="/Essay/assets/js/105.f9cce720.js"><link rel="prefetch" href="/Essay/assets/js/106.677f8141.js"><link rel="prefetch" href="/Essay/assets/js/107.5544f008.js"><link rel="prefetch" href="/Essay/assets/js/108.63843ae0.js"><link rel="prefetch" href="/Essay/assets/js/109.001c499c.js"><link rel="prefetch" href="/Essay/assets/js/11.fa2d8d42.js"><link rel="prefetch" href="/Essay/assets/js/110.856da04e.js"><link rel="prefetch" href="/Essay/assets/js/111.c1b3a67f.js"><link rel="prefetch" href="/Essay/assets/js/112.ac04e6cd.js"><link rel="prefetch" href="/Essay/assets/js/113.af48fb4b.js"><link rel="prefetch" href="/Essay/assets/js/114.0e8a1eb9.js"><link rel="prefetch" href="/Essay/assets/js/115.11a80f30.js"><link rel="prefetch" href="/Essay/assets/js/116.dcc93589.js"><link rel="prefetch" href="/Essay/assets/js/117.8eaa04df.js"><link rel="prefetch" href="/Essay/assets/js/118.ab3c9a9d.js"><link rel="prefetch" href="/Essay/assets/js/119.86c39ff8.js"><link rel="prefetch" href="/Essay/assets/js/12.e183db89.js"><link rel="prefetch" href="/Essay/assets/js/120.b65df74c.js"><link rel="prefetch" href="/Essay/assets/js/121.2355c5b9.js"><link rel="prefetch" href="/Essay/assets/js/122.950466a8.js"><link rel="prefetch" href="/Essay/assets/js/123.62766e15.js"><link rel="prefetch" href="/Essay/assets/js/124.619299a0.js"><link rel="prefetch" href="/Essay/assets/js/125.e1b25322.js"><link rel="prefetch" href="/Essay/assets/js/126.19559d73.js"><link rel="prefetch" href="/Essay/assets/js/127.93dbb17a.js"><link rel="prefetch" href="/Essay/assets/js/128.222a492a.js"><link rel="prefetch" href="/Essay/assets/js/129.7a73a3cf.js"><link rel="prefetch" href="/Essay/assets/js/13.58392c01.js"><link rel="prefetch" href="/Essay/assets/js/130.73fa9147.js"><link rel="prefetch" href="/Essay/assets/js/131.c8420018.js"><link rel="prefetch" href="/Essay/assets/js/132.3fa3f2f2.js"><link rel="prefetch" href="/Essay/assets/js/133.8dc406d5.js"><link rel="prefetch" href="/Essay/assets/js/14.2f3280d2.js"><link rel="prefetch" href="/Essay/assets/js/15.4b4a9ed9.js"><link rel="prefetch" href="/Essay/assets/js/16.e6ab8925.js"><link rel="prefetch" href="/Essay/assets/js/17.42d28dc3.js"><link rel="prefetch" href="/Essay/assets/js/18.4267fffd.js"><link rel="prefetch" href="/Essay/assets/js/19.7b279d9b.js"><link rel="prefetch" href="/Essay/assets/js/20.76019f24.js"><link rel="prefetch" href="/Essay/assets/js/21.bdc098f6.js"><link rel="prefetch" href="/Essay/assets/js/22.b9bc1cab.js"><link rel="prefetch" href="/Essay/assets/js/23.6b0865ee.js"><link rel="prefetch" href="/Essay/assets/js/24.5718b9a4.js"><link rel="prefetch" href="/Essay/assets/js/25.4cff40a9.js"><link rel="prefetch" href="/Essay/assets/js/27.bca6c4ab.js"><link rel="prefetch" href="/Essay/assets/js/28.f860757a.js"><link rel="prefetch" href="/Essay/assets/js/29.732a459c.js"><link rel="prefetch" href="/Essay/assets/js/3.7728e2dd.js"><link rel="prefetch" href="/Essay/assets/js/30.2d0dd622.js"><link rel="prefetch" href="/Essay/assets/js/31.3a59887c.js"><link rel="prefetch" href="/Essay/assets/js/32.346f5205.js"><link rel="prefetch" href="/Essay/assets/js/33.2b7ce348.js"><link rel="prefetch" href="/Essay/assets/js/34.59d64862.js"><link rel="prefetch" href="/Essay/assets/js/35.95383a34.js"><link rel="prefetch" href="/Essay/assets/js/36.0e59c618.js"><link rel="prefetch" href="/Essay/assets/js/37.fba6e883.js"><link rel="prefetch" href="/Essay/assets/js/38.b4f2670f.js"><link rel="prefetch" href="/Essay/assets/js/39.fb894f82.js"><link rel="prefetch" href="/Essay/assets/js/4.25b95440.js"><link rel="prefetch" href="/Essay/assets/js/40.de7a05ef.js"><link rel="prefetch" href="/Essay/assets/js/41.d6f83c69.js"><link rel="prefetch" href="/Essay/assets/js/42.a8ececd0.js"><link rel="prefetch" href="/Essay/assets/js/43.49442f47.js"><link rel="prefetch" href="/Essay/assets/js/44.11a004c1.js"><link rel="prefetch" href="/Essay/assets/js/45.bbb3858a.js"><link rel="prefetch" href="/Essay/assets/js/46.5ae7ded3.js"><link rel="prefetch" href="/Essay/assets/js/47.d49bb64c.js"><link rel="prefetch" href="/Essay/assets/js/48.0a1e6c28.js"><link rel="prefetch" href="/Essay/assets/js/49.dcf0ceae.js"><link rel="prefetch" href="/Essay/assets/js/5.271ed121.js"><link rel="prefetch" href="/Essay/assets/js/50.4dc5dce2.js"><link rel="prefetch" href="/Essay/assets/js/51.ed6f2294.js"><link rel="prefetch" href="/Essay/assets/js/52.0301f341.js"><link rel="prefetch" href="/Essay/assets/js/53.50a188fd.js"><link rel="prefetch" href="/Essay/assets/js/54.05d71eaf.js"><link rel="prefetch" href="/Essay/assets/js/55.fae429b2.js"><link rel="prefetch" href="/Essay/assets/js/56.a86d62bd.js"><link rel="prefetch" href="/Essay/assets/js/57.c4d00df1.js"><link rel="prefetch" href="/Essay/assets/js/58.dbcc6aaa.js"><link rel="prefetch" href="/Essay/assets/js/59.cd7fca77.js"><link rel="prefetch" href="/Essay/assets/js/6.eec2be96.js"><link rel="prefetch" href="/Essay/assets/js/60.9274fd1e.js"><link rel="prefetch" href="/Essay/assets/js/61.9eb5a725.js"><link rel="prefetch" href="/Essay/assets/js/62.adbf06d4.js"><link rel="prefetch" href="/Essay/assets/js/63.9bbebb7b.js"><link rel="prefetch" href="/Essay/assets/js/64.ce3c534f.js"><link rel="prefetch" href="/Essay/assets/js/65.c5a4385e.js"><link rel="prefetch" href="/Essay/assets/js/66.2edd41ad.js"><link rel="prefetch" href="/Essay/assets/js/67.ecf242b2.js"><link rel="prefetch" href="/Essay/assets/js/68.70bd1e2c.js"><link rel="prefetch" href="/Essay/assets/js/69.ae0f2ab1.js"><link rel="prefetch" href="/Essay/assets/js/7.c687dfa3.js"><link rel="prefetch" href="/Essay/assets/js/70.dc29f028.js"><link rel="prefetch" href="/Essay/assets/js/71.c7287773.js"><link rel="prefetch" href="/Essay/assets/js/72.818cfdff.js"><link rel="prefetch" href="/Essay/assets/js/73.cb087392.js"><link rel="prefetch" href="/Essay/assets/js/74.5c6f9ff6.js"><link rel="prefetch" href="/Essay/assets/js/75.83fb8a1e.js"><link rel="prefetch" href="/Essay/assets/js/76.c40b056a.js"><link rel="prefetch" href="/Essay/assets/js/77.afe0804d.js"><link rel="prefetch" href="/Essay/assets/js/78.c80ad412.js"><link rel="prefetch" href="/Essay/assets/js/79.1b32c3ef.js"><link rel="prefetch" href="/Essay/assets/js/8.a17e13b7.js"><link rel="prefetch" href="/Essay/assets/js/80.5cc5c256.js"><link rel="prefetch" href="/Essay/assets/js/81.52c378e6.js"><link rel="prefetch" href="/Essay/assets/js/82.7d110119.js"><link rel="prefetch" href="/Essay/assets/js/83.82a331d0.js"><link rel="prefetch" href="/Essay/assets/js/84.bd574398.js"><link rel="prefetch" href="/Essay/assets/js/85.95b9080a.js"><link rel="prefetch" href="/Essay/assets/js/86.2578a8de.js"><link rel="prefetch" href="/Essay/assets/js/87.ff670ae8.js"><link rel="prefetch" href="/Essay/assets/js/88.13426b2a.js"><link rel="prefetch" href="/Essay/assets/js/89.85a5fef9.js"><link rel="prefetch" href="/Essay/assets/js/9.423f48b9.js"><link rel="prefetch" href="/Essay/assets/js/90.ddb4447f.js"><link rel="prefetch" href="/Essay/assets/js/91.b35e5f0f.js"><link rel="prefetch" href="/Essay/assets/js/92.f9ee1479.js"><link rel="prefetch" href="/Essay/assets/js/93.36f0630c.js"><link rel="prefetch" href="/Essay/assets/js/94.cbee88ed.js"><link rel="prefetch" href="/Essay/assets/js/95.688d4712.js"><link rel="prefetch" href="/Essay/assets/js/96.b6510a7d.js"><link rel="prefetch" href="/Essay/assets/js/97.94dea4b5.js"><link rel="prefetch" href="/Essay/assets/js/98.73e73dc7.js"><link rel="prefetch" href="/Essay/assets/js/99.a06f00a5.js">
    <link rel="stylesheet" href="/Essay/assets/css/0.styles.c2c42747.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Essay/" class="home-link router-link-active"><img src="/Essay/1.gif" alt="娃哈哈" class="logo"> <span class="site-name can-hide">娃哈哈</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Essay/resource/" class="nav-link router-link-active">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="github" class="dropdown-title"><span class="title">github</span> <span class="arrow down"></span></button> <button type="button" aria-label="github" class="mobile-dropdown-title"><span class="title">github</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/boyhaha" target="_blank" rel="noopener noreferrer" class="nav-link external">
  娃哈哈
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Essay/resource/" class="nav-link router-link-active">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="github" class="dropdown-title"><span class="title">github</span> <span class="arrow down"></span></button> <button type="button" aria-label="github" class="mobile-dropdown-title"><span class="title">github</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/boyhaha" target="_blank" rel="noopener noreferrer" class="nav-link external">
  娃哈哈
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>进阶操作</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Essay/resource/database/MongoDB_H.html#引子" class="sidebar-link">引子</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Essay/resource/database/MongoDB_H.html#正文" class="sidebar-link">正文</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Essay/resource/database/MongoDB_H.html#queryplanner" class="sidebar-link">queryPlanner</a></li><li class="sidebar-sub-header"><a href="/Essay/resource/database/MongoDB_H.html#executionstats" class="sidebar-link">executionStats</a></li><li class="sidebar-sub-header"><a href="/Essay/resource/database/MongoDB_H.html#indexfilter" class="sidebar-link">IndexFilter</a></li><li class="sidebar-sub-header"><a href="/Essay/resource/database/MongoDB_H.html#stage的意义" class="sidebar-link">Stage的意义</a></li><li class="sidebar-sub-header"><a href="/Essay/resource/database/MongoDB_H.html#allplansexecution" class="sidebar-link">allPlansExecution</a></li><li class="sidebar-sub-header"><a href="/Essay/resource/database/MongoDB_H.html#对explain返回逐层分析" class="sidebar-link">对Explain返回逐层分析</a></li><li class="sidebar-sub-header"><a href="/Essay/resource/database/MongoDB_H.html#explain分析实例" class="sidebar-link">Explain分析实例</a></li></ul></li><li><a href="/Essay/resource/database/MongoDB_H.html#问题" class="sidebar-link">问题</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="进阶操作"><a href="#进阶操作" class="header-anchor">#</a> 进阶操作</h1> <ul><li><h1 id="进阶操作-2"><a href="#进阶操作-2" class="header-anchor">#</a> 进阶操作</h1> <ul><li>bulk_write</li> <li>InsertOne, DeleteOne, ReplaceOne</li></ul> <h1 id="mongodb权威指南"><a href="#mongodb权威指南" class="header-anchor">#</a> MongoDB权威指南</h1> <ul><li>mongo shell 插入的数字都是浮点型</li></ul> <div class="language- extra-class"><pre class="language-text"><code>引用：“shell中的数字都被MongoDB当作是双精度数。这意味着如果你从数据库中获得的是一个32位整数，修改文档后，将文档存回数据库的时候，这个整数也就被换成了浮点数，即便保持这个整数原封不动也会这样的。”

参考：《MongoDB权威指南》第一版
</code></pre></div><h1 id="分片"><a href="#分片" class="header-anchor">#</a> 分片</h1> <h3 id="慢查询监控"><a href="#慢查询监控" class="header-anchor">#</a> 慢查询监控</h3> <ul><li><h4 id="profiling级别说明"><a href="#profiling级别说明" class="header-anchor">#</a> Profiling级别说明</h4></li></ul> <div class="language- extra-class"><pre class="language-text"><code>0：关闭，不收集任何数据。
1：收集慢查询数据，默认是100毫秒。
2：收集所有数据


#查看状态：级别和时间
PRIMARY&gt; db.getProfilingStatus()
{ &quot;was&quot; : 1, &quot;slowms&quot; : 200 }
#查看级别
PRIMARY&gt; db.getProfilingLevel()
1
#设置级别
PRIMARY&gt; db.setProfilingLevel(2)
{ &quot;was&quot; : 1, &quot;slowms&quot; : 100, &quot;ok&quot; : 1 }
#设置级别和时间
PRIMARY&gt; db.setProfilingLevel(1,200)
{ &quot;was&quot; : 2, &quot;slowms&quot; : 100, &quot;ok&quot; : 1 }


db.system.profile.find().pretty()
</code></pre></div><h3 id="使用javascript操作mongodb"><a href="#使用javascript操作mongodb" class="header-anchor">#</a> 使用JavaScript操作MongoDB</h3> <div class="language-js extra-class"><pre class="language-js"><code>
</code></pre></div><h3 id="查看数据库空间大小"><a href="#查看数据库空间大小" class="header-anchor">#</a> 查看数据库空间大小</h3> <ul><li>db.stats();</li></ul> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;db&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;xxx&quot;</span><span class="token punctuation">,</span>   <span class="token comment">//当前数据库</span>
    <span class="token property">&quot;collections&quot;</span> <span class="token operator">:</span> <span class="token number">27</span><span class="token punctuation">,</span>  <span class="token comment">//当前数据库多少表 </span>
    <span class="token property">&quot;objects&quot;</span> <span class="token operator">:</span> <span class="token number">18738550</span><span class="token punctuation">,</span>  <span class="token comment">//当前数据库所有表多少条数据</span>
    <span class="token property">&quot;avgObjSize&quot;</span> <span class="token operator">:</span> <span class="token number">1153.54876188392</span><span class="token punctuation">,</span> <span class="token comment">//每条数据的平均大小</span>
    <span class="token property">&quot;dataSize&quot;</span> <span class="token operator">:</span> <span class="token number">21615831152.0</span><span class="token punctuation">,</span>  <span class="token comment">//所有数据的总大小</span>
    <span class="token property">&quot;storageSize&quot;</span> <span class="token operator">:</span> <span class="token number">23223312272.0</span><span class="token punctuation">,</span>  <span class="token comment">//所有数据占的磁盘大小 </span>
    <span class="token property">&quot;numExtents&quot;</span> <span class="token operator">:</span> <span class="token number">121</span><span class="token punctuation">,</span>
    <span class="token property">&quot;indexes&quot;</span> <span class="token operator">:</span> <span class="token number">26</span><span class="token punctuation">,</span>   <span class="token comment">//索引数 </span>
    <span class="token property">&quot;indexSize&quot;</span> <span class="token operator">:</span> <span class="token number">821082976</span><span class="token punctuation">,</span>  <span class="token comment">//索引大小 </span>
    <span class="token property">&quot;fileSize&quot;</span> <span class="token operator">:</span> <span class="token number">25691160576.0</span><span class="token punctuation">,</span>  <span class="token comment">//预分配给数据库的文件大小</span>
    <span class="token property">&quot;nsSizeMB&quot;</span> <span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
    <span class="token property">&quot;dataFileVersion&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;major&quot;</span> <span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
        <span class="token property">&quot;minor&quot;</span> <span class="token operator">:</span> <span class="token number">5</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;extentFreeList&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;num&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">&quot;totalSize&quot;</span> <span class="token operator">:</span> <span class="token number">65536</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;ok&quot;</span> <span class="token operator">:</span> <span class="token number">1.0</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="mongodb-执行计划-1"><a href="#mongodb-执行计划-1" class="header-anchor">#</a> MongoDB 执行计划 <a href="https://segmentfault.com/a/1190000012208991" target="_blank" rel="noopener noreferrer">1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h3> <ul><li><p>db.collection.explain()</p></li> <li><p>db.collection.explain(&quot;executionStats&quot;)</p></li> <li><p><a href="http://xstarcd.github.io/wiki/sysadmin/mongodb_slowlog.html" target="_blank" rel="noopener noreferrer">慢查询日志<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><h2 id="引子"><a href="#引子" class="header-anchor">#</a> 引子</h2></li></ul> <p>MongoDB 3.0之后，explain的返回与使用方法与之前版本有了不少变化，介于3.0之后的优秀特色，本文仅针对MongoDB 3.0+的explain进行讨论。</p> <p>现版本explain有三种模式，分别如下：</p> <ul><li>queryPlanner</li> <li>executionStats</li> <li>allPlansExecution</li></ul> <h2 id="正文"><a href="#正文" class="header-anchor">#</a> 正文</h2> <h3 id="queryplanner"><a href="#queryplanner" class="header-anchor">#</a> queryPlanner</h3> <p>queryPlanner是现版本explain的默认模式，queryPlanner模式下并不会去真正进行query语句查询，而是针对query语句进行执行计划分析并选出winning plan。</p> <p>先来看queryPlanner模式的各个返回意义。</p> <p><strong>explain.queryPlanner</strong></p> <p>queryPlanner的返回。</p> <p><strong>explain.queryPlanner.namespace</strong></p> <p>顾名思义，该值返回的是该query所查询的表。</p> <p><strong>explain.queryPlanner.indexFilterSet</strong></p> <p>针对该query是否有indexfilter（会在后文进行详细解释）。</p> <p><strong>explain.queryPlanner.winningPlan</strong></p> <p>查询优化器针对该query所返回的最优执行计划的详细内容。</p> <p><strong>explain.queryPlanner.winningPlan.stage</strong></p> <p>最优执行计划的stage，这里返回是FETCH，可以理解为通过返回的index位置去检索具体的文档（stage有数个模式，将在后文中进行详解）。</p> <p><strong>explain.queryPlanner.winningPlan.inputStage</strong></p> <p>explain.queryPlanner.winningPlan.stage的child stage，此处是IXSCAN，表示进行的是index scanning。</p> <p><strong>explain.queryPlanner.winningPlan.keyPattern</strong></p> <p>所扫描的index内容，此处是w:1与n:1。</p> <p><strong>explain.queryPlanner.winningPlan.indexName</strong></p> <p>winning plan所选用的index。</p> <p><strong>explain.queryPlanner.winningPlan.isMultiKey</strong></p> <p>是否是Multikey，此处返回是false，如果索引建立在array上，此处将是true。</p> <p><strong>explain.queryPlanner.winningPlan.direction</strong></p> <p>此query的查询顺序，此处是forward，如果用了.sort({w:-1})将显示backward。</p> <p><strong>explain.queryPlanner.winningPlan.indexBounds</strong></p> <p>winningplan所扫描的索引范围，此处查询条件是w:1,使用的index是w与n的联合索引，故w是[1.0,1.0]而n没有指定在查询条件中，故是[MinKey,MaxKey]。</p> <p><strong>explain.queryPlanner.rejectedPlans</strong></p> <p>其他执行计划（非最优而被查询优化器reject的）的详细返回，其中具体信息与winningPlan的返回中意义相同，故不在此赘述。</p> <h3 id="executionstats"><a href="#executionstats" class="header-anchor">#</a> executionStats</h3> <p>executionStats的返回中多了如下：</p> <p>executionStats模式中，我们主要需要注意的返回有如下几个</p> <p><strong>executionStats.executionSuccess</strong></p> <p>是否执行成功</p> <p><strong>executionStats.nReturned</strong></p> <p>查询的返回条数</p> <p><strong>executionStats.executionTimeMillis</strong></p> <p>整体执行时间</p> <p><strong>executionStats.totalKeysExamined</strong></p> <p>索引扫描次数</p> <p><strong>executionStats.totalDocsExamined</strong></p> <p>document扫描次数</p> <p>以上几个非常好理解，我们就不在这里详述，后文的案例中会有分析。</p> <p><strong>executionStats.executionStages.stage</strong></p> <p>这里是FETCH去扫描对于documents</p> <p><strong>executionStats.executionStages.nReturned</strong></p> <p>由于是FETCH，所以这里该值与executionStats.nReturned一致</p> <p><strong>executionStats.executionStages.docsExamined</strong></p> <p>与executionStats.totalDocsExamined一致</p> <p><strong>executionStats.inputStage</strong>中的与上述理解方式相同</p> <p>还有一些文档中没有描述的返回如：</p> <p>“works” : 29862,</p> <p>“advanced” : 29861,</p> <p>“isEOF” : 1,</p> <p>这些值都会在explan之初初始化：</p> <p>mongo/src/mongo/db/exec/plan_stats.h</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">CommonStats</span> <span class="token punctuation">{</span>
  <span class="token function">CommonStats</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> type<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">stageTypeStr</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">works</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">yields</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">unyields</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">invalidates</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">advanced</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">needTime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">needYield</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">executionTimeMillis</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">isEOF</span><span class="token punctuation">(</span>false<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

</code></pre></div><p>以works为例，查看源码中发现，每次操作会加1，且会把执行时间记录在executionTimeMillis中。</p> <p>mongo/src/mongo/db/exec/fetch.cpp</p> <div class="language- extra-class"><pre class="language-text"><code>      ++_commonStats.works;

      // Adds the amount of time taken by work() to executionTimeMillis.
      ScopedTimer timer(&amp;_commonStats.executionTimeMillis);
</code></pre></div><p>而在查询结束EOF，works又会加1，advanced不加。</p> <p>mongo/src/mongo/db/exec/eof.cpp</p> <div class="language- extra-class"><pre class="language-text"><code>PlanStage::StageState EOFStage::work(WorkingSetID* out) {
  ++_commonStats.works;
  // Adds the amount of time taken by work() to executionTimeMillis.
  ScopedTimer timer(&amp;_commonStats.executionTimeMillis);
  return PlanStage::IS_EOF;
  }
</code></pre></div></li></ul> <p>故正常的返回works会比nReturned多1，这时候isEOF为true（1）：</p> <p>mongo/src/mongo/db/exec/eof.cpp</p> <div class="language- extra-class"><pre class="language-text"><code>bool EOFStage::isEOF() {
  return true;
  }

  unique_ptr EOFStage::getStats() {
      _commonStats.isEOF = isEOF();
      return make_unique(_commonStats, STAGE_EOF);
  }
</code></pre></div><p>advanced的返回值在命中的时候+1，在skip,eof的时候不会增加如：</p> <p>mongo/src/mongo/db/exec/skip.cpp</p> <div class="language- extra-class"><pre class="language-text"><code>if (PlanStage::ADVANCED == status) {
      // If we're still skipping results...
      if (_toSkip &gt; 0) {
          // ...drop the result.
          --_toSkip;
          _ws-&gt;free(id);
          ++_commonStats.needTime;
          return PlanStage::NEED_TIME;
      }

      *out = id;
      ++_commonStats.advanced;
      return PlanStage::ADVANCED;

</code></pre></div><h3 id="indexfilter"><a href="#indexfilter" class="header-anchor">#</a> IndexFilter</h3> <p>IndexFilter决定了查询优化器对于某一类型的查询将如何使用index，indexFilter仅影响查询优化器对于该类查询可以用尝试哪些index的执行计划分析，查询优化器还是根据分析情况选择最优计划。</p> <p>如果某一类型的查询设定了IndexFilter，那么执行时通过hint指定了其他的index，查询优化器将会忽略hint所设置index，仍然使用indexfilter中设定的查询计划。</p> <p>IndexFilter可以通过命令移除，也将在实例重启后清空。</p> <h4 id="indexfilter的创建"><a href="#indexfilter的创建" class="header-anchor">#</a> IndexFilter的创建</h4> <p>可以通过如下命令为某一个collection建立indexFilter</p> <div class="language- extra-class"><pre class="language-text"><code>db.runCommand(
  {
      planCacheSetFilter: &lt;collection&gt;,
      query: &lt;query&gt;,
      sort: &lt;sort&gt;,
      projection: &lt;projection&gt;,
      indexes: [ &lt;index1&gt;, &lt;index2&gt;, ...]
  }
)

db.runCommand(
  {
      planCacheSetFilter: &quot;orders&quot;,
      query: { status: &quot;A&quot; },
      indexes: [
          { cust_id: 1, status: 1 },
          { status: 1, order_date: -1 }
      ]
  }
)
</code></pre></div><p>上图针对orders表建立了一个indexFilter，indexFilter指定了对于orders表只有status条件（仅对status进行查询，无sort等）的查询的indexes，故下图的查询语句的查询优化器仅仅会从<code>{cust_id:1,status:1}</code>和<code>{status:1,order_date:-1}</code>中进行winning plan的选择</p> <div class="language- extra-class"><pre class="language-text"><code>db.orders.find( { status: &quot;D&quot; } )
db.orders.find( { status: &quot;P&quot; } )
</code></pre></div><h5 id="indexfilter的列表"><a href="#indexfilter的列表" class="header-anchor">#</a> indexFilter的列表</h5> <p>可以通过如下命令展示某一个collecton的所有indexFilter</p> <div class="language- extra-class"><pre class="language-text"><code>db.runCommand( { planCacheListFilters:  } )
</code></pre></div><h5 id="indexfilter的删除"><a href="#indexfilter的删除" class="header-anchor">#</a> indexFilter的删除</h5> <p>可以通过如下命令对IndexFilter进行删除</p> <div class="language- extra-class"><pre class="language-text"><code>db.runCommand(
 {
    planCacheClearFilters: &lt;collection&gt;,
    query: &lt;query pattern&gt;,
    sort: &lt;sort specification&gt;,
    projection: &lt;projection specification&gt;
 }
)
</code></pre></div><h3 id="stage的意义"><a href="#stage的意义" class="header-anchor">#</a> Stage的意义</h3> <p>如<strong>explain.queryPlanner.winningPlan.stage</strong>和<strong>explain.queryPlanner.winningPlan.inputStage</strong>等。</p> <p>文档中仅有如下几类介绍</p> <p><strong>COLLSCAN</strong></p> <p>全表扫描</p> <p><strong>IXSCAN</strong></p> <p>索引扫描</p> <p><strong>FETCH</strong></p> <p>根据索引去检索指定document</p> <p><strong>SHARD_MERGE</strong></p> <p>将各个分片返回数据进行merge</p> <p>但是根据源码中的信息，个人还总结了文档中没有的如下几类(常用如下，由于是通过源码查找，可能有所遗漏)</p> <p><strong>SORT</strong></p> <p>表明在内存中进行了排序（与老版本的scanAndOrder:true一致）</p> <p><strong>LIMIT</strong></p> <p>使用limit限制返回数</p> <p><strong>SKIP</strong></p> <p>使用skip进行跳过</p> <p><strong>IDHACK</strong></p> <p>针对_id进行查询</p> <p><strong>SHARDING_FILTER</strong></p> <p>通过mongos对分片数据进行查询</p> <p><strong>COUNT</strong></p> <p>利用db.coll.explain().count()之类进行count运算</p> <p><strong>COUNTSCAN</strong></p> <p>count不使用用Index进行count时的stage返回</p> <p><strong>COUNT_SCAN</strong></p> <p>count使用了Index进行count时的stage返回</p> <p><strong>SUBPLA</strong></p> <p>未使用到索引的$or查询的stage返回</p> <p><strong>TEXT</strong></p> <p>使用全文索引进行查询时候的stage返回</p> <p><strong>PROJECTION</strong></p> <p>限定返回字段时候stage的返回</p> <h3 id="allplansexecution"><a href="#allplansexecution" class="header-anchor">#</a> allPlansExecution</h3> <p>顾名思义，allPlansExecution模式是将所有的执行计划均进行executionStats模式的操作，不在此赘述了。</p> <h3 id="对explain返回逐层分析"><a href="#对explain返回逐层分析" class="header-anchor">#</a> 对Explain返回逐层分析</h3> <h4 id="第一层-executiontimemillis。"><a href="#第一层-executiontimemillis。" class="header-anchor">#</a> 第一层，executionTimeMillis。</h4> <p>首先，最为直观explain返回值是<strong>executionTimeMillis</strong>值，指的是我们这条语句的执行时间，这个值当然是希望越少越好。</p> <p>且<strong>executionTimeMillis</strong> 与stage有同样的层数，即：</p> <p>其中有3个<strong>executionTimeMillis</strong>，分别是</p> <p><strong>executionStats.executionTimeMillis</strong></p> <p>该query的整体查询时间</p> <p><strong>executionStats.executionStages.executionTimeMillis</strong></p> <p>该查询根据index去检索document获取29861条具体数据的时间</p> <p><strong>executionStats.executionStages.inputStage.executionTimeMillis</strong></p> <p>该查询扫描29861行index所用时间</p> <p>这三个值我们都希望越少越好，那么是什么影响这这三个返回值呢？</p> <p>抛开硬件因素等不谈，我们来进行下一层的剥离。</p> <p>#### 第二层，index与document扫描数与查询返回条目数</p> <p>这里主要谈3个返回项，nReturned，totalKeysExamined与totalDocsExamined，分别代表该条查询返回的条目、索引扫描条目和文档扫描条目。</p> <p>很好理解，这些都直观的影响到executionTimeMillis，我们需要扫描的越少速度越快。</p> <p>对于一个查询， 我们最理想的状态是</p> <p>nReturned=totalKeysExamined &amp; totalDocsExamined=0</p> <p>（cover index，仅仅使用到了index，无需文档扫描，这是最理想状态。）</p> <p>或者</p> <p>nReturned=totalKeysExamined=totalDocsExamined(需要具体情况具体分析)</p> <p>（正常index利用，无多余index扫描与文档扫描。）</p> <p>如果有sort的时候，为了使得sort不在内存中进行，我们可以在保证nReturned=totalDocsExamined</p> <p>的基础上，totalKeysExamined可以大于totalDocsExamined与nReturned，因为量级较大的时候内存排序非常消耗性能。</p> <p>后面我们会针对例子来进行分析。</p> <h4 id="第三层-stage状态分析"><a href="#第三层-stage状态分析" class="header-anchor">#</a> 第三层，Stage状态分析</h4> <p>那么又是什么影响到了totalKeysExamined与totalDocsExamined呢？就是Stage的类型，Stage的具体含义在上文中有提及，如果认真看的同学就不难理解为何Stage会影响到totalKeysExamined 和totalDocsExamined从而影响executionTimeMillis了。</p> <p>此前有讲解过stage的类型，这里再简单列举下（具体意义请看上文）</p> <p><strong>COLLSCAN</strong></p> <p><strong>IXSCAN</strong></p> <p><strong>FETCH</strong></p> <p><strong>SHARD_MERGE</strong></p> <p><strong>SORT</strong></p> <p><strong>LIMIT</strong></p> <p><strong>SKIP</strong></p> <p><strong>IDHACK</strong></p> <p><strong>SHARDING_FILTER</strong></p> <p><strong>COUNT</strong></p> <p><strong>COUNTSCAN</strong></p> <p><strong>COUNT_SCAN</strong></p> <p><strong>SUBPLA</strong></p> <p><strong>TEXT</strong></p> <p><strong>PROJECTION</strong></p> <h4 id="对于普通查询-我们最希望看到的组合有这些"><a href="#对于普通查询-我们最希望看到的组合有这些" class="header-anchor">#</a> 对于普通查询，我们最希望看到的组合有这些：</h4> <p>Fetch+IDHACK</p> <p>Fetch+ixscan</p> <p>Limit+（Fetch+ixscan）</p> <p>PROJECTION+ixscan</p> <p>SHARDING_FILTER+ixscan</p> <p>等</p> <h4 id="不希望看到包含如下的stage"><a href="#不希望看到包含如下的stage" class="header-anchor">#</a> 不希望看到包含如下的stage：</h4> <p>COLLSCAN（全表扫），SORT（使用sort但是无index），不合理的SKIP，SUBPLA（未用到index的$or）</p> <h4 id="对于count查询-希望看到的有"><a href="#对于count查询-希望看到的有" class="header-anchor">#</a> 对于count查询，希望看到的有：</h4> <p>COUNT_SCAN</p> <h4 id="不希望看到的有"><a href="#不希望看到的有" class="header-anchor">#</a> 不希望看到的有:</h4> <p>COUNTSCAN</p> <h3 id="explain分析实例"><a href="#explain分析实例" class="header-anchor">#</a> Explain分析实例</h3> <p>表中数据如下(简单测试用例，仅10条数据，主要是对explain分析的逻辑进行解析)：</p> <p>综上可以有一个小结论，当查询覆盖精确匹配，范围查询与排序的时候，</p> <p><code>精确匹配字段,排序字段,范围查询字段,</code>这样的索引排序会更为高效</p> <ul><li><h1 id="大坑"><a href="#大坑" class="header-anchor">#</a> 大坑</h1> <h2 id="问题"><a href="#问题" class="header-anchor">#</a> 问题</h2> <ol><li>MongoDB建索引导致CPU 100%
<ol><li>查询正在建索引的op<div class="language-json extra-class"><pre class="language-json"><code>db.currentOp(
    <span class="token punctuation">{</span>
      $or<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> op<span class="token operator">:</span> <span class="token string">&quot;command&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;query.createIndexes&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> $exists<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> op<span class="token operator">:</span> <span class="token string">&quot;none&quot;</span><span class="token punctuation">,</span> ns<span class="token operator">:</span> /\.system\.indexes\b/ <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
)
</code></pre></div></li> <li>杀掉对应的op<div class="language- extra-class"><pre class="language-text"><code>db.killOp(opid)
</code></pre></div></li> <li>如果找不到opid, 可以rename当前collection终止建立索引操作, 等待几分钟恢复到原collection<div class="language- extra-class"><pre class="language-text"><code>db.collection.renameCollection(&quot;new_collection&quot;)
</code></pre></div></li></ol></li> <li>reIndex
<ol><li>不同版本之间, reIndex的 exclusive lock不同, 但是还是不推荐使用, 就想官方文档所说, 太昂贵</li></ol></li></ol></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">7/16/2021, 5:49:13 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/Essay/assets/js/app.4cbbe458.js" defer></script><script src="/Essay/assets/js/2.495d5abd.js" defer></script><script src="/Essay/assets/js/26.041d7297.js" defer></script>
  </body>
</html>
